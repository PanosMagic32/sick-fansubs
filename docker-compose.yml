services:
  # ========================================
  # MongoDB Database (commented out)
  # ========================================
  # mongodb:
  #   image: mongo:8
  #   container_name: sick-mongodb
  #   restart: unless-stopped
  #   environment:
  #     MONGO_INITDB_DATABASE: sick-db
  #     MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-root}
  #     MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-root_password}
  #   ports:
  #     - "27017:27017"
  #   volumes:
  #     - mongo_data:/data/db
  #     - mongo_config:/data/configdb
  #   networks:
  #     - sick-nw
  #   healthcheck:
  #     test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 40s

  # ========================================
  # NestJS API Service
  # ========================================
  api:
    container_name: sick-api
    build:
      context: .
      dockerfile: Dockerfile
      target: api
      args:
        NODE_VERSION: lts-alpine
    env_file:
      - .env
    environment:
      NODE_ENV: production
      PORT: 3333
    ports:
      - '${API_PORT:-3333}:3333'
    # depends_on:
    #   mongodb:
    #     condition: service_healthy
    restart: unless-stopped
    networks:
      - sick-nw
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # ========================================
  # Nginx + Angular Web Service
  # ========================================
  web:
    container_name: sick-web
    build:
      context: .
      dockerfile: Dockerfile
      target: web
      args:
        NGINX_VERSION: 1.27-alpine
    env_file:
      - .env
    ports:
      - '${WEB_HTTP_PORT:-80}:8080'
      - '${WEB_HTTPS_PORT:-443}:8443'
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - sick-nw
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.25'
          memory: 64M
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

# ========================================
# Volumes
# ========================================
# volumes:
#   mongo_data:
#     driver: local
#   mongo_config:
#     driver: local

# ========================================
# Networks
# ========================================
networks:
  sick-nw:
    driver: bridge
    name: sick-network
