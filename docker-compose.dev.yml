
# Development docker-compose configuration
# Usage: docker compose -f docker-compose.dev.yml up

services:
  # ========================================
  # MongoDB Database for Development
  # ========================================
  mongodb:
    image: mongo:8
    container_name: sick-mongodb-dev
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: sick-db
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root_password
    ports:
      - "27017:27017"
    volumes:
      - mongo_data_dev:/data/db
      - mongo_config_dev:/data/configdb
    networks:
      - sick-nw-dev
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ========================================
  # NestJS API Service (Development)
  # ========================================
  api:
    container_name: sick-api-dev
    build:
      context: .
      dockerfile: Dockerfile
      target: api
      args:
        NODE_VERSION: 24-alpine
    env_file:
      - .env
    environment:
      NODE_ENV: development
      PORT: 3333
    ports:
      - "3333:3333"
      - "9229:9229"  # Node.js debugger port
    volumes:
      # Mount source code for hot-reload
      - ./apps/api:/app/apps/api:ro
      - ./libs:/app/libs:ro
      - /app/node_modules  # Prevent overwriting node_modules
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - sick-nw-dev
    command: ["node", "--inspect=0.0.0.0:9229", "dist/main.js"]

  # ========================================
  # Nginx + Angular Web Service (Development)
  # ========================================
  web:
    container_name: sick-web-dev
    build:
      context: .
      dockerfile: Dockerfile
      target: web
      args:
        NGINX_VERSION: 1.27-alpine
    env_file:
      - .env
    ports:
      - "4200:8080"
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - sick-nw-dev

  # ========================================
  # Mongo Express (Optional DB Admin UI)
  # ========================================
  mongo-express:
    image: mongo-express:latest
    container_name: sick-mongo-express
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: root
      ME_CONFIG_MONGODB_ADMINPASSWORD: root_password
      ME_CONFIG_MONGODB_URL: mongodb://root:root_password@mongodb:27017/
      ME_CONFIG_BASICAUTH: false
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - sick-nw-dev

volumes:
  mongo_data_dev:
    driver: local
  mongo_config_dev:
    driver: local

networks:
  sick-nw-dev:
    driver: bridge
    name: sick-network-dev
